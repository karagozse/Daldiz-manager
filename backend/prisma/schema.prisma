generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id        String   @id @default(uuid())
  key       String   @unique
  name      String
  status    String   @default("active")
  createdAt DateTime @default(now())
  users     User[]
  campuses  Campus[]

  @@map("tenants")
}

model User {
  id                                              Int                         @id @default(autoincrement())
  tenantId                                        String
  username                                        String
  passwordHash                                    String
  displayName                                     String
  role                                            Role
  email                                           String?                     @unique
  isActive                                        Boolean                     @default(true)
  createdAt                                       DateTime                    @default(now())
  updatedAt                                       DateTime                    @updatedAt
  tenant                                          Tenant                      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  closedCriticalWarnings                          CriticalWarning[]           @relation("ClosedBy")
  createdCriticalWarnings                         CriticalWarning[]           @relation("CreatedBy")
  inspections                                     Inspection[]
  prescriptions_prescriptions_createdByIdTousers  Prescription[]              @relation("prescriptions_createdByIdTousers")
  prescriptions_prescriptions_reviewedByIdTousers Prescription[]              @relation("prescriptions_reviewedByIdTousers")
  user_notification_settings                      user_notification_settings?
  web_push_subscriptions                          web_push_subscriptions[]

  @@unique([tenantId, username])
  @@index([tenantId])
  @@map("users")
}

model Campus {
  id            String
  tenantId      String
  name          String
  weight        Float
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  gardens       Garden[]       @relation("CampusGardens")
  prescriptions Prescription[]

  @@id([tenantId, id])
  @@index([tenantId])
  @@map("campuses")
}

model Garden {
  id               Int               @id @default(autoincrement())
  tenantId         String
  name             String
  status           GardenStatus      @default(ACTIVE)
  campusTenantId   String
  campusId         String
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  criticalWarnings CriticalWarning[]
  campus           Campus            @relation("CampusGardens", fields: [campusTenantId, campusId], references: [tenantId, id])
  inspections      Inspection[]
  harvestEntries   HarvestEntry[]

  @@index([tenantId])
  @@index([campusTenantId, campusId])
  @@index([status])
  @@map("gardens")
}

model Trader {
  id             String         @id @default(uuid())
  tenantId       String
  name           String
  createdAt      DateTime       @default(now())
  harvestEntries HarvestEntry[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@index([name])
  @@map("traders")
}

model HarvestEntry {
  id                      String         @id @default(uuid())
  tenantId                String
  gardenId                Int
  traderId                String?        @map("trader_id")
  traderName              String         @default("") @map("trader_name")
  date                    DateTime       @db.Date
  name                    String
  status                  String         @default("draft") // draft | submitted
  pricePerKg              Decimal        @default(0) @map("price_per_kg") @db.Decimal(12, 4)
  grade1Kg                Decimal?       @map("grade1_kg") @db.Decimal(12, 4)
  grade2Kg                Decimal?       @map("grade2_kg") @db.Decimal(12, 4)
  thirdLabel               String?       @map("third_label")
  thirdKg                  Decimal?      @map("third_kg") @db.Decimal(12, 4)
  thirdPricePerKg          Decimal?      @map("third_price_per_kg") @db.Decimal(12, 4)
  independentScaleFullKg  Decimal?      @map("independent_scale_full_kg") @db.Decimal(12, 4)
  independentScaleEmptyKg  Decimal?      @map("independent_scale_empty_kg") @db.Decimal(12, 4)
  traderScaleFullKg        Decimal?      @map("trader_scale_full_kg") @db.Decimal(12, 4)
  traderScaleEmptyKg       Decimal?      @map("trader_scale_empty_kg") @db.Decimal(12, 4)
  createdAt               DateTime       @default(now())
  updatedAt               DateTime       @updatedAt
  submittedAt             DateTime?      @map("submitted_at")
  garden                  Garden         @relation(fields: [gardenId], references: [id])
  trader                  Trader?        @relation(fields: [traderId], references: [id])
  photos                  HarvestPhoto[]

  @@index([tenantId])
  @@index([gardenId])
  @@index([traderId])
  @@index([date])
  @@index([status])
  @@map("harvest_entries")
}

model HarvestPhoto {
  id          String        @id @default(uuid())
  harvestId   String        @map("harvest_id")
  category    String        // GENERAL | TRADER_SLIP
  url         String
  createdAt   DateTime      @default(now())
  harvest     HarvestEntry  @relation(fields: [harvestId], references: [id], onDelete: Cascade)

  @@index([harvestId])
  @@index([category])
  @@map("harvest_photos")
}

model Inspection {
  id               String            @id @default(uuid())
  tenantId         String
  gardenId         Int
  createdById      Int
  status           InspectionStatus  @default(DRAFT)
  submittedAt      DateTime?
  createdAt        DateTime          @default(now())
  score            Int?
  topics           Json?
  criticalWarnings CriticalWarning[]
  createdBy        User              @relation(fields: [createdById], references: [id])
  garden           Garden            @relation(fields: [gardenId], references: [id])

  @@index([tenantId])
  @@index([gardenId])
  @@index([createdById])
  @@index([status])
  @@map("inspections")
}

model CriticalWarning {
  id           String                   @id @default(uuid())
  inspectionId String
  gardenId     Int
  topicId      Int
  title        String
  description  String
  status       CriticalWarningStatus    @default(OPEN)
  openedAt     DateTime                 @default(now())
  closedAt     DateTime?
  closureNote  String?
  severity     CriticalWarningSeverity?
  createdById  Int?
  closedById   Int?
  createdAt    DateTime                 @default(now())
  updatedAt    DateTime                 @updatedAt
  closedBy     User?                    @relation("ClosedBy", fields: [closedById], references: [id])
  createdBy    User?                    @relation("CreatedBy", fields: [createdById], references: [id])
  garden       Garden                   @relation(fields: [gardenId], references: [id], onDelete: Cascade)
  inspection   Inspection               @relation(fields: [inspectionId], references: [id], onDelete: Cascade)

  @@index([gardenId, status])
  @@index([status, topicId])
  @@index([openedAt])
  @@index([inspectionId])
  @@map("critical_warnings")
}

model Prescription {
  id                Int       @id @default(autoincrement())
  tenantId          String
  campusTenantId    String
  campusId          String
  createdById       Int
  createdAt         DateTime  @default(now())
  ventilation       String?
  irrigation        String?
  fertilization     String?
  status            String    @default("draft")
  reviewedById      Int?
  reviewedAt        DateTime?
  campuses          Campus    @relation(fields: [campusTenantId, campusId], references: [tenantId, id])
  users_prescriptions_createdByIdTousers  User      @relation("prescriptions_createdByIdTousers", fields: [createdById], references: [id])
  users_prescriptions_reviewedByIdTousers User?     @relation("prescriptions_reviewedByIdTousers", fields: [reviewedById], references: [id])

  @@index([tenantId])
  @@index([status])
  @@index([campusTenantId, campusId])
  @@index([createdById])
  @@index([reviewedById])
  @@map("prescriptions")
}

model playing_with_neon {
  id    Int    @id @default(autoincrement())
  name  String
  value Float? @db.Real
}

model user_notification_settings {
  id                       Int      @id @default(autoincrement())
  userId                   Int      @unique
  campusBelek              Boolean  @default(true)
  campusCandir             Boolean  @default(true)
  campusManavgat           Boolean  @default(true)
  enableNewEvaluation      Boolean  @default(true)
  enableNewPrescription    Boolean  @default(true)
  enableNewCriticalWarning Boolean  @default(true)
  createdAt                DateTime @default(now())
  updatedAt                DateTime
  users                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model web_push_subscriptions {
  id        Int      @id @default(autoincrement())
  userId    Int
  endpoint  String   @unique
  p256dh    String
  auth      String
  userAgent String?
  createdAt DateTime @default(now())
  updatedAt DateTime
  users     User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

enum Role {
  CONSULTANT
  LEAD_AUDITOR
  ADMIN
  SUPER_ADMIN
}

enum GardenStatus {
  ACTIVE
  INACTIVE
}

enum InspectionStatus {
  DRAFT
  SUBMITTED
}

enum CriticalWarningStatus {
  OPEN
  CLOSED
}

enum CriticalWarningSeverity {
  LOW
  MEDIUM
  HIGH
}

enum PrescriptionStatus {
  PENDING
  APPROVED
}
